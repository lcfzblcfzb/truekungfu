[gd_scene load_steps=15 format=2]

[ext_resource path="res://tiles/dungeon.tres" type="TileSet" id=1]
[ext_resource path="res://Player/Guard.tscn" type="PackedScene" id=2]
[ext_resource path="res://Player/PlayerMain/PlayerMain.tscn" type="PackedScene" id=3]
[ext_resource path="res://Sprite.gd" type="Script" id=4]
[ext_resource path="res://texture/disk_mask.png" type="Texture" id=5]
[ext_resource path="res://texture/borbidencity_brick_tiled.png" type="Texture" id=6]
[ext_resource path="res://shader/FOG.shader" type="Shader" id=7]
[ext_resource path="res://texture/borbidencity_brick_tiled_NRM.jpg" type="Texture" id=8]

[sub_resource type="Shader" id=1]
code = "shader_type canvas_item;

// MODES
// 0 - DEBUG
// 1 - MULTIPLY
// 2 - SCREEN
// 3 - SOFTLIGHT
// 4 - HARDLIGHT
// 5 - OVERLAY
uniform int mode :hint_range(0,5) = 5;
uniform bool linearColorSpace = false;
uniform vec4 color1 :hint_color = vec4(1, 0.5, 0.8, 1);
uniform vec4 color2 :hint_color = vec4(0.4, 0.8, 1, 1);
uniform vec2 direction = vec2(1.0, 1.0);
uniform float opacity :hint_range(0, 1) = 0.5;

 vec3 srgb_to_linear(vec3 c){
	return c * (c * (c * 0.305306011 + 0.682171111) + 0.012522878);
}

vec3 linear_to_srgb(vec3 c){
	return max(1.055 * pow(c, vec3(0.416666667)) - 0.055, 0.0);
}

void fragment(){
	vec2 uv = FRAGCOORD.xy / (1.0 / SCREEN_PIXEL_SIZE).xy;
	vec4 src = texture(SCREEN_TEXTURE, uv);
	
	vec3 c_a = src.rgb;
	vec3 grad1 = color1.rgb;
	vec3 grad2 = color2.rgb;
	vec3 c_f;
	
	if (linearColorSpace){ 
		c_a = linear_to_srgb(c_a);
		grad1 = linear_to_srgb(grad1);
		grad2 = linear_to_srgb(grad2);
	}

	float param = dot(uv - 0.5, direction);
	vec3 c_b = mix(grad1, grad2, param + 0.5);
	
	if (mode == 0){       // DEBUG
		c_f = c_b;
	}else if (mode == 1){ // MULTIPLY
		c_f = c_a * c_b;
	}else if (mode == 2){ // SCREEN
		c_f = 1.0 - (1.0 - c_a) * (1.0 - c_b);
	}else if (mode == 3){ // SOFTLIGHT
		vec3 c_u = c_a * c_b * 2.0 + (1.0 - c_b * 2.0) * c_a * c_a;
		vec3 c_d = (1.0 - c_b) * c_a * 2.0 + (c_b * 2.0 - 1.0) * sqrt(c_a);
		c_f = mix(c_u, c_d, c_b + 0.5);
	}else if (mode == 4){ // HARDLIGHT
		vec3 c_u = c_a * c_b * 2.0;
		vec3 c_d = 1.0 - (1.0 - c_a) * (1.0 - c_b) * 2.0;
		c_f = mix(c_u, c_d, c_b + 0.5);
	}else if (mode == 5){ // OVERLAY
		vec3 c_u = c_a * c_b * 2.0;
		vec3 c_d = 1.0 - (1.0 - c_a) * (1.0 - c_b) * 2.0;
		c_f = mix (c_u, c_d, c_a + 0.5);
	}
	
	if (linearColorSpace){
		c_f = srgb_to_linear(c_f);
	}

	COLOR = vec4(c_f, opacity);
    }"

[sub_resource type="ShaderMaterial" id=2]
shader = SubResource( 1 )
shader_param/mode = 5
shader_param/linearColorSpace = false
shader_param/color1 = Color( 0.890196, 0.866667, 0.882353, 1 )
shader_param/color2 = Color( 0.0313726, 0.0980392, 0.129412, 1 )
shader_param/direction = Vector2( 1, 1 )
shader_param/opacity = 0.603

[sub_resource type="OpenSimplexNoise" id=3]

[sub_resource type="NoiseTexture" id=4]
noise = SubResource( 3 )

[sub_resource type="ShaderMaterial" id=5]
shader = ExtResource( 7 )
shader_param/octaves = 4
shader_param/starting_amplitude = 0.372
shader_param/starting_frequency = 1.0
shader_param/shift = -0.172
shader_param/velocity = Vector2( 100, 100 )
shader_param/fog_color = Color( 0, 0, 0, 1 )
shader_param/noise = SubResource( 4 )

[sub_resource type="Environment" id=6]
ambient_light_color = Color( 0.901961, 0.141176, 0.141176, 1 )
glow_enabled = true

[node name="TestScene" type="Node2D"]

[node name="TileMap" type="TileMap" parent="."]
tile_set = ExtResource( 1 )
cell_size = Vector2( 16, 16 )
cell_custom_transform = Transform2D( 0, 0, 0, 32, 0, 0 )
format = 1
tile_data = PoolIntArray( 65539, 38, 0, 65540, 38, 1, 65541, 38, 3, 65544, 38, 0, 65545, 38, 1, 65546, 38, 3, 65549, 38, 0, 131074, 3, 0, 131075, 38, 65536, 131076, 38, 65537, 131077, 38, 0, 131078, 38, 3, 131079, 38, 0, 131080, 38, 65536, 131081, 38, 131074, 131082, 38, 0, 131083, 38, 1, 131084, 38, 2, 131085, 38, 2, 131086, 38, 1, 131087, 38, 2, 131088, 38, 2, 131089, 38, 3, 196610, 4, 0, 196611, 38, 196608, 196612, 38, 0, 196613, 38, 131074, 196614, 38, 131075, 196615, 0, 0, 196616, 38, 65536, 196617, 38, 65538, 196618, 38, 131074, 196619, 38, 131074, 196620, 38, 131073, 196621, 38, 65538, 196622, 38, 131073, 196623, 38, 65537, 196624, 38, 131073, 196625, 38, 131075, 262146, 4, 0, 262147, 4, 0, 262148, 38, 196608, 262149, 38, 196609, 262150, 38, 0, 262151, 38, 2, 262152, 38, 0, 262153, 38, 131074, 262154, 38, 131074, 262155, 38, 65538, 262156, 38, 65538, 262157, 38, 65537, 262158, 38, 131073, 262159, 38, 65538, 262160, 38, 0, 262161, 38, 196611, 327683, 38, 0, 327684, 38, 3, 327685, 6, 0, 327686, 38, 65536, 327687, 38, 131074, 327688, 38, 131073, 327689, 38, 131073, 327690, 38, 131074, 327691, 38, 131073, 327692, 38, 131073, 327693, 38, 131073, 327694, 38, 65537, 327695, 38, 65537, 327696, 38, 65539, 393217, 6, 4, 393218, 6, 0, 393219, 38, 65536, 393220, 38, 0, 393221, 38, 1, 393222, 38, 0, 393223, 38, 131073, 393224, 38, 65537, 393225, 38, 131073, 393226, 38, 65538, 393227, 38, 131073, 393228, 38, 65537, 393229, 38, 65538, 393230, 38, 131074, 393231, 38, 0, 393232, 38, 196611, 458753, 6, 65540, 458754, 6, 0, 458755, 38, 196608, 458756, 38, 196610, 458757, 38, 196610, 458758, 38, 196610, 458759, 38, 0, 458760, 38, 131074, 458761, 38, 65538, 458762, 38, 65537, 458763, 38, 131073, 458764, 38, 0, 458765, 38, 196609, 458766, 38, 196610, 458767, 38, 196611, 524289, 6, 131076, 524290, 6, 0, 524291, 38, 0, 524292, 6, 0, 524293, 6, 0, 524294, 6, 0, 524295, 38, 196608, 524296, 38, 196609, 524297, 38, 196609, 524298, 38, 196610, 524299, 38, 196609, 524300, 38, 196611, 589835, 38, 0 )

[node name="Light2D" type="Light2D" parent="."]
position = Vector2( -133.78, 174.311 )
scale = Vector2( 0.607631, 0.623078 )
texture = ExtResource( 5 )
range_height = 134.7
shadow_enabled = true
shadow_color = Color( 0.843137, 0.137255, 0.137255, 0 )

[node name="Guard" parent="." instance=ExtResource( 2 )]
position = Vector2( 146.301, 76.4538 )

[node name="Sprite" type="Sprite" parent="."]
material = SubResource( 2 )
position = Vector2( 83.1791, 77.6661 )
texture = ExtResource( 6 )
normal_map = ExtResource( 8 )
script = ExtResource( 4 )

[node name="Sprite2" type="Sprite" parent="."]
material = SubResource( 5 )
position = Vector2( 63.1979, 89.5441 )
scale = Vector2( 2.6616, 1.9177 )
texture = ExtResource( 6 )
normal_map = ExtResource( 8 )
script = ExtResource( 4 )

[node name="WorldEnvironment" type="WorldEnvironment" parent="."]
environment = SubResource( 6 )

[node name="MainPlayer" parent="." instance=ExtResource( 3 )]
position = Vector2( 222.55, 64.8075 )
